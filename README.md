# README

## Описание

Проект состоит из двух Qt-приложений:

- **Agent** — подключается к контроллеру, выполняет задачи в отдельном потоке и отправляет статусы.
- **Controller** — управляет одним агентом, хранит задачи в SQLite, отображает их в таблице и позволяет создавать и отменять задачи.

Взаимодействие между агентом и контроллером построено на **QTcpSocket** и **protobuf**.
Сообщения передаются в виде protobuf-структур, упакованных в `Envelope` и обрамлённых префиксом длины (length-prefixed framing).

---

## Возможности

### Agent
- Подключается к контроллеру по IP/порту.
- Выполняет вычислительные задачи (`sum 1..N`) в отдельном QThread.
- Поддерживает отмену задачи.
- Передаёт контроллеру статусы выполнения (0–100%).

### Controller
- Слушает порт и принимает одно соединение от агента.
- Создаёт задачи (с параметром `N`).
- Отображает список задач в `QTableWidget` (ID, статус, прогресс, результат).
- Отменяет выбранную задачу.
- Хранит задачи в базе **SQLite** (`controller_tasks.sqlite`).

---

## Архитектура

- **ProtoChannel** — общий класс для обмена protobuf-сообщениями поверх TCP (length-prefixed).
- **AgentClient** — TCP-клиент агента, принимает `TaskRequest`, запускает `SumTaskWorker`.
- **SumTaskWorker** — потоковый воркер (QThread), считает сумму от 1 до N, периодически обновляет прогресс.
- **ControllerServer** — TCP-сервер, принимает агента, отправляет `TaskRequest`/`CancelTask`, получает `TaskStatus`.
- **ControllerDb** — обёртка над SQLite для хранения задач.
- **UI**:
  - `AgentWindow` — форма для подключения к контроллеру.
  - `ControllerWindow` — форма с таблицей задач, кнопками «Создать» и «Отменить».

---

## Протокол сообщений (protobuf)

Файл: [`proto/task.proto`](proto/task.proto)

- `Handshake` — идентификатор агента и версия протокола.
- `TaskRequest` — запрос задачи (`id`, `task_type="sum"`, `param_n`).
- `TaskResponse` — подтверждение создания задачи (успех/ошибка).
- `TaskStatus` — статус выполнения (`id`, `status`, `progress`, `result`).
- `CancelTask` — запрос отмены задачи.
- `Envelope` — универсальная обёртка: `{ kind, payload }`.

---

## Схема БД

```sql
CREATE TABLE tasks (
    id TEXT PRIMARY KEY,
    status TEXT,
    progress INTEGER,
    result INTEGER
);
```

---

## Сборка

Требуется:
- **Qt 5.15+** (Widgets, Network, Sql)
- **protobuf** (`protoc`, `libprotobuf-dev`)
- **CMake 3.10+**
- g++ (C++17)

Команды:

```bash
./scripts/build.sh
```

После сборки исполняемые файлы будут доступны в `build/`:
- `build/agent`
- `build/controller`

---

## Запуск

1. Запустить **Controller**:
   ```bash
   ./build/controller
   ```
   В интерфейсе указать порт (по умолчанию 5555) и нажать «Слушать».

2. Запустить **Agent**:
   ```bash
   ./build/agent
   ```
   Ввести `127.0.0.1` и порт `5555`, нажать «Подключиться».

3. В контроллере:
   - Ввести `N` (например, `1000000`).
   - Нажать «Создать задачу».
   - В таблице появится задача, начнёт обновляться прогресс, в конце отобразится результат.

4. Для отмены:
   - Выбрать строку в таблице.
   - Нажать «Отменить задачу».

---

## Добавление нового типа задачи

1. Реализовать новый `TaskWorker` (например, `FibonacciTaskWorker`), наследуя от `QThread`.
2. В `AgentClient::handleTaskRequest` добавить ветку с разбором `task_type`.
3. В контроллере:
   - Передавать нужный `task_type` в `TaskRequest`.
   - При необходимости добавить UI для выбора типа задачи.
4. При необходимости расширить SQLite-схему (добавить поля или отдельную таблицу).

---

## Скрипты

- `scripts/build.sh` — сборка проекта.
- `scripts/run_all.sh` — запуск контроллера и агента в одном терминале.
